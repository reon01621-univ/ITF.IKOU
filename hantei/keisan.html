<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ITF.IKOU - 移行判定</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="/style.css">
    
    <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

</head>
<body>

    <header class="header">
        <h1>ITF.IKOU</h1>
        <h3>筑波大学総合学域群非公式情報サイト</h3>
    </header>

    <div class="site-container">
        <div class="sidebar">
            <nav>
                <ul>
                    <li><a href="/index.html">TOP</a></li>
                    <li><a href="/sougou/index.html">総合学域群について</a></li>
                    <li>
                        <a href="#">移行先学類・専門学群</a>
                        <ul>
                            <li><a href="#">情報科学類</a></li>
                            <li><a href="#">情報メディア創成学類</a></li>
                            <li><a href="#">知識情報・図書館学類</a></li>
                        </ul>
                    </li>
                    <li><a href="/hantei/index.html">移行判定</a>
                        <ul>
                            <li><a href="/hantei/keisan.html">点数計算/登録</a></li>
                        </ul>
                    </li>
                    <li><a href="/jugyo_kensaku/index.html">授業評価検索</a></li>
                </ul>
            </nav>
        </div>

        <main class="main-content">
            <div id="main-app">
                <div class="panel">
                    <h2>区分枠登録</h2>
                    <p>あなたの区分枠を選択してください。この情報は送信時に利用されます。</p>
                    <select id="category-select">
                        <option value="unselected">選択してください</option>
                        <option value="arts">文系</option>
                        <option value="sci_1">理系Ⅰ</option>
                        <option value="sci_2">理系Ⅱ</option>
                        <option value="sci_3">理系Ⅲ</option>
                    </select>
                </div>
                
                <div class="panel">
                    <h2>
                        <span>志望学類登録</span>
                        <button id="toggle-majors-btn" class="btn-toggle">表示</button>
                    </h2>
                    <div id="major-priority-content" style="display: none;">
                        <p>計算したい学類の志望度を1(高)〜5(低)で入力してください。同じ番号も使えます。空欄の学類は計算されません。</p>
                        <div class="table-wrapper">
                            <table class="priority-table">
                                <thead><tr><th>学類名</th><th>志望度 (1-5)</th></tr></thead>
                                <tbody id="major-priority-body"></tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <div class="panel">
                    <h2>履修科目リストの編集</h2>
                    <div class="search-section">
                        <div id="loading-status"></div>
                        <input type="text" id="search-input" placeholder="科目ライブラリから検索...">
                        <div id="search-results"></div>
                    </div>
                    <div class="table-wrapper">
                        <table id="subjects-table">
                            <thead><tr><th class="col-name">科目名</th><th class="col-credits">単位数</th><th class="col-grade">成績</th><th class="col-actions">操作</th></tr></thead>
                            <tbody></tbody>
                        </table>
                    </div>
                    <button id="add-row-btn" class="btn-add">手動で科目を追加</button>
                    <button id="save-btn" class="btn-main">現在のリストを保存・計算実行</button>
                </div>
                
                <div id="results-panel" class="panel" style="display:none;">
                    <h2>計算結果</h2>
                    <p>志望度とスコアを基にソートして表示しています。</p>
                    <div class="table-wrapper">
                        <table id="results-table">
                            <thead><tr><th>学類名</th><th>志望度</th><th>計算スコア</th><th>得点率</th></tr></thead>
                            <tbody id="results-table-body"></tbody>
                        </table>
                    </div>
                    <button id="submit-results-btn" class="btn-main">計算結果を送信</button>
                </div>
            </div>
        </main>
    </div>

    <script>

        function normalizeName(name) { if (typeof name !== 'string') return ''; return name.replace(/[０-９]/g, (s) => String.fromCharCode(s.charCodeAt(0) - 0xFEE0)).replace(/\s+/g, ''); }
        function calculateStandardMajor(subjects, rule) { let breakdown = []; let totalScore = 0; let totalCredits = 0; let maxScore = 0; const includedNames = new Set(); const combinedLimitUsedCredits = {}; (rule.combinedLimits || []).forEach(limit => { combinedLimitUsedCredits[limit.name] = 0; }); (rule.groups || []).forEach(group => { let groupSubjects = subjects.filter(s => (group.subjects || []).includes(s.name)); groupSubjects.sort((a, b) => b.grade - a.grade); let groupCredits = 0; groupSubjects.forEach(subject => { if (includedNames.has(subject.name)) return; if (rule.totalCap > 0 && totalCredits + subject.credits > rule.totalCap) return; if (group.cap > 0 && groupCredits + subject.credits > group.cap) return; let exceedsCombinedLimit = false; (rule.combinedLimits || []).forEach(limit => { if ((limit.groupNames || []).includes(group.name)) { if (combinedLimitUsedCredits[limit.name] + subject.credits > limit.cap) { exceedsCombinedLimit = true; } } }); if (exceedsCombinedLimit) return; groupCredits += subject.credits; totalCredits += subject.credits; totalScore += subject.grade * subject.credits * group.weight; maxScore += 100 * subject.credits * group.weight; breakdown.push({ text: `${subject.name} (${group.name})`, status: 'included'}); includedNames.add(subject.name); (rule.combinedLimits || []).forEach(limit => { if ((limit.groupNames || []).includes(group.name)) { combinedLimitUsedCredits[limit.name] += subject.credits; } }); }); }); const remainingSubjects = subjects.filter(s => !includedNames.has(s.name)); remainingSubjects.forEach(s => s.efficiency = s.grade * (rule.otherWeight || 0)); remainingSubjects.sort((a, b) => b.efficiency - a.efficiency); for (const subject of remainingSubjects) { if (!rule.totalCap || rule.totalCap === 0 || totalCredits + subject.credits <= rule.totalCap) { totalCredits += subject.credits; totalScore += subject.grade * subject.credits * rule.otherWeight; maxScore += 100 * subject.credits * rule.otherWeight; breakdown.push({ text: `${subject.name} (その他)`, status: 'included' }); includedNames.add(subject.name); } } subjects.forEach(s => { if (!includedNames.has(s.name)) { breakdown.push({ text: s.name, status: 'excluded', reason: '優先度不足または上限超過' }); } }); return { score: totalScore, credits: totalCredits, breakdown, maxScore }; }
        function calculateTieredMajor(subjects, rule) { const allSubjects = JSON.parse(JSON.stringify(subjects)); let breakdown = []; const tier1_subjects_raw = []; const other_subjects_raw = []; allSubjects.forEach(s => { const normalizedName = normalizeName(s.name); if ((rule.priorityKeywords || []).some(kw => normalizedName.includes(kw))) { s.weight = rule.priorityWeight || 2.0; tier1_subjects_raw.push(s); } else { other_subjects_raw.push(s); } }); other_subjects_raw.sort((a, b) => b.grade - a.grade); const tier2_subjects_pool = []; let otherPriorityCredits = 0; const otherPriorityCap = rule.otherPriorityCap === undefined ? 4.0 : rule.otherPriorityCap; for (const subject of other_subjects_raw) { if (otherPriorityCap > 0 && otherPriorityCredits >= otherPriorityCap) break; if (otherPriorityCap > 0 && otherPriorityCredits + subject.credits > otherPriorityCap) continue; otherPriorityCredits += subject.credits; subject.weight = 1.0; subject.efficiency = subject.grade * subject.weight; tier2_subjects_pool.push(subject); } const combinedPriority = [...tier1_subjects_raw, ...tier2_subjects_pool]; combinedPriority.forEach(s => s.efficiency = s.grade * s.weight); combinedPriority.sort((a, b) => b.efficiency - a.efficiency); let totalScore = 0; let totalCredits = 0; let maxScore = 0; const includedNames = new Set(); const rulePriorityCap = rule.priorityCreditCap || 18; const ruleTotalCap = rule.totalCap || 24; const ruleOverflowWeight = rule.overflowWeight === undefined ? 0.1 : rule.overflowWeight; for (const subject of combinedPriority) { if ((ruleTotalCap > 0 && totalCredits >= ruleTotalCap) || (rulePriorityCap > 0 && totalCredits >= rulePriorityCap)) break; if ((ruleTotalCap > 0 && totalCredits + subject.credits > ruleTotalCap) || (rulePriorityCap > 0 && totalCredits + subject.credits > rulePriorityCap)) continue; totalCredits += subject.credits; totalScore += subject.grade * subject.credits * subject.weight; maxScore += 100 * subject.credits * subject.weight; breakdown.push({ text: `${subject.name} [貢献:${(subject.grade * subject.credits * subject.weight).toFixed(2)}] (x${subject.weight})`, status: 'included' }); includedNames.add(subject.name); } let remainingSubjects = allSubjects.filter(s => !includedNames.has(s.name)); remainingSubjects.forEach(s => { s.weight = s.weight || 1.0; s.efficiency = s.grade * s.weight * ruleOverflowWeight; }); remainingSubjects.sort((a, b) => b.efficiency - a.efficiency); for (const subject of remainingSubjects) { if (ruleTotalCap > 0 && totalCredits >= ruleTotalCap) break; if (ruleTotalCap > 0 && totalCredits + subject.credits > ruleTotalCap) continue; const scoreToAdd = subject.grade * subject.credits * subject.weight * ruleOverflowWeight; const maxScoreToAdd = 100 * subject.credits * subject.weight * ruleOverflowWeight; totalCredits += subject.credits; totalScore += scoreToAdd; maxScore += maxScoreToAdd; breakdown.push({ text: `${subject.name} [貢献:${scoreToAdd.toFixed(2)}] (x${subject.weight} @ ${ruleOverflowWeight}倍)`, status: 'included' }); includedNames.add(subject.name); } allSubjects.forEach(s => { if (!includedNames.has(s.name)) { breakdown.push({ text: s.name, status: 'excluded', reason: '優先度不足または上限超過' }); } }); return { score: totalScore, credits: totalCredits, breakdown, maxScore }; }



        const majorRulesFromSQL = [
            {"name": "数学類(理系Ⅰ)", "rule_data": {"groups":[{"cap":18,"name":"重点科目","weight":1,"subjects":["地球環境学1","地球環境学2","地球進化学2","地球進化学1","生物学序説","生物資源の開発・生産と持続利用","生物資源と環境","数学リテラシー1","数学リテラシー2","微分積分A","微積分1","微積分2","微積分3","線形代数A","線形代数1","線形代数2","線形代数3","力学1","力学2","力学3","電磁気1","電磁気2","電磁気3","化学1","化学2","化学3"]}],"otherCap":0,"totalCap":24,"thresholds":{"applicable":{"pass":1056.7,"median":1405.8},"non_applicable":{"pass":0,"median":0}},"otherWeight":1,"combinedLimits":[],"maxPossibleScore":1860}},
            {"name": "情報科学類(区分B)", "rule_data": {"groups":[],"otherCap":0,"totalCap":24,"thresholds":{"applicable":{"pass":0,"median":0},"non_applicable":{"pass":2122,"median":2149}},"otherWeight":1,"combinedLimits":[],"maxPossibleScore":2400}},
            {"name": "工学システム学類", "rule_data": {"groups":[{"cap":18,"name":"重点科目","weight":1,"subjects":["数学リテラシー1","数学リテラシー2","微積分3","線形代数3","力学1","力学2","力学3","電磁気学1","電磁気学2","電磁気学3"]},{"cap":2,"name":"微分積分","weight":1,"subjects":["微分積分A","微積分1","微積分2"]},{"cap":2,"name":"線形代数","weight":1,"subjects":["線形代数A","線形代数1","線形代数2"]},{"cap":4,"name":"その他の重点科目","weight":1,"subjects":[]}],"otherCap":0,"totalCap":24,"thresholds":{"applicable":{"pass":1530.9,"median":1627.12},"non_applicable":{"pass":1542.15,"median":1560.12}},"otherWeight":0.1,"combinedLimits":[{"cap":18,"name":"合計","groupNames":["重点科目","微分積分","線形代数","その他の重点科目"]}],"maxPossibleScore":1860}},
            {"name": "物理学類", "rule_data": {"groups":[{"cap":18,"name":"重点科目","weight":2,"subjects":["力学1","力学2","力学3","電磁気1","電磁気2","電磁気3","物理学入門","数学リテラシー1","数学リテラシー2","微積分3","線形代数3"]},{"cap":2,"name":"微分積分","weight":2,"subjects":["微分積分A","微積分1","微積分2"]},{"cap":2,"name":"線形代数","weight":2,"subjects":["線形代数A","線形代数1","線形代数2"]},{"cap":0,"name":"重点科目（その他）","weight":1,"subjects":[]}],"otherCap":0,"totalCap":24,"thresholds":{"applicable":{"pass":2511.35,"median":2828.85},"non_applicable":{"pass":2463.2,"median":2472.35}},"otherWeight":0.1,"combinedLimits":[{"cap":18,"name":"重点科目","groupNames":["重点科目","微分積分","線形代数","重点科目（その他）"]}],"maxPossibleScore":3260}},
            {"name": "生物学類(区分A)", "rule_data": {"groups":[{"cap":2,"name":"グループA","weight":2,"subjects":["系統分類・進化学概論","分子細胞生物学概論","生態学概論","動物生理学概論","遺伝学概論"]},{"cap":6,"name":"グループB","weight":1,"subjects":["系統分類・進化学概論","分子細胞生物学概論","遺伝学概論","生態学概論","動物生理学概論","生物学序説","生物資源と環境","生物資源としての遺伝子とゲノム","地球進化学1","数学リテラシー1","数学リテラシー2","微分積分A","微積分1","微積分2","線形代数A","線形代数1","線形代数2","力学1","力学2","力学3","電磁気学1","電磁気学2","電磁気学3","化学1","化学2","化学3"]}],"otherCap":0,"totalCap":24,"thresholds":{"applicable":{"pass":611.15,"median":800.9},"non_applicable":{"pass":561.25,"median":611.15}},"otherWeight":1,"combinedLimits":[],"maxPossibleScore":980}},
            {"name": "医学類", "rule_data": {"groups":[{"cap":4,"name":"医科","weight":2,"subjects":["医科生化学","医科分子生物学"]},{"cap":4,"name":"物理化学","weight":1,"subjects":["力学1","電磁気学1","化学2","化学3"]}],"otherCap":0,"totalCap":24,"thresholds":{"applicable":{"pass":0,"median":0},"non_applicable":{"pass":1186.45,"median":1247.5}},"otherWeight":0.1,"combinedLimits":[],"maxPossibleScore":1360}},
            {"name": "医療科学類", "rule_data": {"groups":[{"cap":8,"name":"重点科目","weight":1,"subjects":["医科生化学","医科分子生物学","人体機能学","人体構造学","医療科学概論"]},{"cap":6,"name":"その他の専門導入科目","weight":1,"subjects":["哲学・宗教学入門","史学入門","考古学・民俗学入門","言語分析入門","個別言語学入門","日本・アジア領域比較文化研究","英米・ヨーロッパ領域比較文化研究","フィールド文化領域比較文化研究","表現文化領域比較文化研究","文化科学領域比較文化研究","思想文化領域比較文化研究","共生のための社会言語学","共生のための日本語教育","共生のための人類学","共生のための歴史学","日本文学と文化","社会学の最前線","法学の最前線","政治学の最前線","経済学の最前線","国際学I","国際学II","国際学III","国際学IV","人間学I","障害科学I","障害科学II","人間学II","教育基礎論","学校の経営・制度・社会","心理学概論","心理学研究法","生物学序説","系統分類・進化学概論","分子細胞生物学概論","遺伝学概論","生態学概論","動物生理学概論","植物生理学概論","生物資源学にみる食品科学・技術の最前線","生物資源の開発・生産と持続利用","生物資源と環境","生物資源としての遺伝子とゲノム","地球環境学1","地球環境学2","地球進化学1","地球進化学2","数学概論","物理学概論","化学概論","応用理工学概論","工学システム概論","経済学の数理","経済学の実証","会計と経営","社会と最適化","都市計画入門","都市数理","知能と情報科学","計算と情報科学","システムと情報科学","情報科学概論","情報メディア入門","コンテンツ入門","知識情報概論","知識情報システム概説","図書館概論","行動生理学の基礎","放射線と生命―人体への影響と医療への貢献―","神経回路研究の最前線","脳神経疾患の概略を理解する","臨床感覚器学","形成外科学入門","医科生化学","医科分子生物学","スポーツ医学とは？フロントランナーに聞いてみよう!!","基礎医学研究の最前線","人体機能学","人体構造学","看護生命倫理","基礎看護学概論","公衆衛生看護学概論","精神看護学概論","高齢者看護学概論","生涯発達と家族支援","医学史","医療・生命科学とテクノロジー","医療科学概論","スポーツの技術を自然科学から考える","オリンピック・スタディーズ","スポーツの技術を人文社会科学から考える","アート＆デザイン入門","芸術と文化","芸術と社会","数学リテラシー1","数学リテラシー2","微積分1","微積分2","微積分3","線形代数1","線形代数2","線形代数3","力学1","力学2","力学3","電磁気学1","電磁気学2","電磁気学3","化学1","化学2","化学3"]}],"otherCap":0,"totalCap":20,"thresholds":{"applicable":{"pass":685.45,"median":762.57},"non_applicable":{"pass":619.55,"median":724.7}},"otherWeight":0.1,"combinedLimits":[{"cap":8,"name":"合計","groupNames":["重点科目","その他の専門導入科目"]}],"maxPossibleScore":920}},
            {"name": "情報科学類(区分A)", "rule_data": {"groups":[{"cap":2,"name":"グループA","weight":1,"subjects":["知能と情報科学","計算と情報科学","システムと情報科学","情報科学概論","情報メディア入門","コンテンツ入門","知識情報概論","知識情報システム概説","図書館概論"]},{"cap":4,"name":"グループB","weight":1,"subjects":["情報数学A","プログラミング入門A"]},{"cap":2,"name":"微分積分","weight":1,"subjects":["微分積分A","微積分1","微積分2"]},{"cap":2,"name":"線形代数","weight":1,"subjects":["線形代数A","線形代数1","線形代数2"]}],"otherCap":0,"totalCap":20,"thresholds":{"applicable":{"pass":918.75,"median":966.87},"non_applicable":{"pass":976.1,"median":976.1}},"otherWeight":0.1,"combinedLimits":[{"cap":8,"name":"グループB","groupNames":["グループB","微分積分","線形代数"]}],"maxPossibleScore":1100}},
            {"name": "化学類", "rule_data": {"groups":[{"cap":18,"name":"重点科目","weight":1,"subjects":["力学1","力学2","力学3","化学1","化学2","化学3","電磁気学1","電磁気学2","電磁気学3","微積分3","線形代数3"]},{"cap":2,"name":"線形代数","weight":1,"subjects":["線形代数A","線形代数1","線形代数2"]},{"cap":2,"name":"微分積分","weight":1,"subjects":["微分積分A","微積分1","微積分2"]},{"cap":4,"name":"生物、地球、数学","weight":1,"subjects":["生物学序説","地球環境学1","地球環境学2","地球進化学1","地球進化学2","数学リテラシー1","数学リテラシー2"]}],"otherCap":0,"totalCap":24,"thresholds":{"applicable":{"pass":1281.6,"median":1492.67},"non_applicable":{"pass":1257.6,"median":1324.92}},"otherWeight":0.1,"combinedLimits":[{"cap":18,"name":"合計","groupNames":["重点科目","線形代数","微分積分","生物、地球、数学"]}],"maxPossibleScore":1860}},
            {"name": "障害科学類", "rule_data": {"groups":[],"otherCap":0,"totalCap":28,"thresholds":{"applicable":{"pass":0,"median":0},"non_applicable":{"pass":2315,"median":2502}},"otherWeight":1,"combinedLimits":[],"maxPossibleScore":2800}},
            {"name": "看護学類", "rule_data": {"groups":[{"cap":2,"name":"グループA","weight":1,"subjects":["看護生命倫理","高齢者看護学概論"]},{"cap":11,"name":"グループB","weight":1,"subjects":["人体機能学","人体構造学","基礎看護学概論","生涯発達と家族支援"]},{"cap":4,"name":"グループB（その他）","weight":1,"subjects":[]}],"otherCap":0,"totalCap":24,"thresholds":{"applicable":{"pass":0,"median":0},"non_applicable":{"pass":0,"median":0}},"otherWeight":0.1,"combinedLimits":[{"cap":11,"name":"グループB","groupNames":["グループB","グループB（その他）"]}],"maxPossibleScore":1400}},
            {"name": "社会工学類", "rule_data": {"groups":[{"cap":3,"name":"重点科目","weight":1,"subjects":["数学リテラシー1","数学リテラシー2","微積分3","線形代数3","経済学の数理","経済学の実証","会計と経営","社会と最適化","都市計画入門","都市数理"]},{"cap":2,"name":"微分積分","weight":1,"subjects":["微分積分A","微積分1","微積分2"]},{"cap":2,"name":"線形代数","weight":1,"subjects":["線形代数A","線形代数1","線形代数2"]}],"otherCap":0,"totalCap":24,"thresholds":{"applicable":{"pass":448.55,"median":474.15},"non_applicable":{"pass":444.9,"median":460.15}},"otherWeight":0.1,"combinedLimits":[{"cap":3,"name":"合計","groupNames":["重点科目","微分積分","線形代数"]}],"maxPossibleScore":510}},
            {"name": "日本語・日本文化学類", "rule_data": {"groups":[],"otherCap":0,"totalCap":24,"thresholds":{"applicable":{"pass":698,"median":1861.25},"non_applicable":{"pass":1957,"median":1957}},"otherWeight":1,"combinedLimits":[],"maxPossibleScore":2400}},
            {"name": "応用理工学類", "rule_data": {"groups":[{"cap":17,"name":"重点科目","weight":1,"subjects":["数学リテラシー1","数学リテラシー2","微積分3","線形代数3","力学1","力学2","力学3","電磁気学1","電磁気学2","電磁気学3","化学1","化学2","化学3"]},{"cap":0,"name":"微積分","weight":1,"subjects":["微積分1","微積分2","微分積分A"]},{"cap":0,"name":"線形代数","weight":1,"subjects":["線形代数1","線形代数2","線形代数A"]},{"cap":1,"name":"専門導入科目","weight":1,"subjects":["哲学・宗教学入門","史学入門","考古学・民俗学入門","言語分析入門","個別言語学入門","日本・アジア領域比較文化研究","英米・ヨーロッパ領域比較文化研究","フィールド文化領域比較文化研究","表現文化領域比較文化研究","文化科学領域比較文化研究","思想文化領域比較文化研究","共生のための社会言語学","共生のための日本語教育","共生のための人類学","共生のための歴史学","日本文学と文化","社会学の最前線","法学の最前線","政治学の最前線","経済学の最前線","国際学I","国際学II","国際学III","国際学IV","人間学I","障害科学I","障害科学II","人間学II","教育基礎論","学校の経営・制度・社会","心理学概論","心理学研究法","生物学序説","系統分類・進化学概論","分子細胞生物学概論","遺伝学概論","生態学概論","動物生理学概論","植物生理学概論","生物資源学にみる食品科学・技術の最前線","生物資源の開発・生産と持続利用","生物資源と環境","生物資源としての遺伝子とゲノム","地球環境学1","地球環境学2","地球進化学1","地球進化学2","数学概論","物理学概論","化学概論","応用理工学概論","工学システム概論","経済学の数理","経済学の実証","会計と経営","社会と最適化","都市計画入門","都市数理","知能と情報科学","計算と情報科学","システムと情報科学","情報科学概論","情報メディア入門","コンテンツ入門","知識情報概論","知識情報システム概説","図書館概論","行動生理学の基礎","放射線と生命―人体への影響と医療への貢献―","神経回路研究の最前線","脳神経疾患の概略を理解する","臨床感覚器学","形成外科学入門","医科生化学","医科分子生物学","スポーツ医学とは？フロントランナーに聞いてみよう!!","基礎医学研究の最前線","人体機能学","人体構造学","看護生命倫理","基礎看護学概論","公衆衛生看護学概論","精神看護学概論","高齢者看護学概論","生涯発達と家族支援","医学史","医療・生命科学とテクノロジー","医療科学概論","スポーツの技術を自然科学から考える","オリンピック・スタディーズ","スポーツの技術を人文社会科学から考える","アート＆デザイン入門","芸術と文化","芸術と社会","数学リテラシー1","数学リテラシー2","微積分1","微積分2","微積分3","線形代数1","線形代数2","線形代数3","力学1","力学2","力学3","電磁気学1","電磁気学2","電磁気学3","化学1","化学2","化学3"]}],"otherCap":0,"totalCap":24,"thresholds":{"applicable":{"pass":1447.55,"median":1604.3},"non_applicable":{"pass":1436.6,"median":1535.62}},"otherWeight":0.1,"combinedLimits":[{"cap":17,"name":"合計","groupNames":["重点科目","微積分","線形代数"]}],"maxPossibleScore":1860}},
            {"name": "数学類(理系Ⅲ)", "rule_data": {"groups":[{"cap":18,"name":"重点科目","weight":1,"subjects":["地球環境学1","地球環境学2","地球進化学2","地球進化学1","生物学序説","生物資源の開発・生産と持続利用","生物資源と環境","数学リテラシー1","数学リテラシー2","微分積分A","微積分1","微積分2","微積分3","線形代数A","線形代数1","線形代数2","線形代数3","力学1","力学2","力学3","電磁気1","電磁気2","電磁気3","化学1","化学2","化学3"]}],"otherCap":0,"totalCap":24,"thresholds":{"applicable":{"pass":1526.5,"median":1526.5},"non_applicable":{"pass":0,"median":0}},"otherWeight":1,"combinedLimits":[],"maxPossibleScore":1860}},
            {"name": "地球学類(理系Ⅰ)", "rule_data": {"groups":[{"cap":12,"name":"重点科目","weight":1,"subjects":["地球環境学1","地球環境学2","地球進化学2","地球進化学1","フィールド文化領域比較文化研究","生物学序説","系統分類・進化学概論","分子細胞生物学概論","遺伝学概論","生態学概論","動物生理学概論","植物生理学概論","生物資源学にみる食品科学・技術の最前線","生物資源の開発・生産と持続利用","生物資源と環境","生物資源としての遺伝子とゲノム","数学リテラシー1","数学リテラシー2","微分積分A","微積分1","微積分2","微積分3","線形代数A","線形代数1","線形代数2","線形代数3","力学1","力学2","力学3","電磁気1","電磁気2","電磁気3","化学1","化学2","化学3"]}],"otherCap":0,"totalCap":24,"thresholds":{"applicable":{"pass":983.8,"median":1088.82},"non_applicable":{"pass":1094,"median":1109.12}},"otherWeight":1,"combinedLimits":[],"maxPossibleScore":1300}},
            {"name": "国際総合学類", "rule_data": {"groups":[],"otherCap":0,"totalCap":24,"thresholds":{"applicable":{"pass":0,"median":0},"non_applicable":{"pass":2019,"median":2125.5}},"otherWeight":1,"combinedLimits":[],"maxPossibleScore":2400}},
            {"name": "教育学類", "rule_data": {"groups":[],"otherCap":0,"totalCap":28,"thresholds":{"applicable":{"pass":0,"median":0},"non_applicable":{"pass":2238.5,"median":2463}},"otherWeight":1,"combinedLimits":[],"maxPossibleScore":2800}},
            {"name": "生物学類(区分B)", "rule_data": {"groups":[],"otherCap":0,"totalCap":24,"thresholds":{"applicable":{"pass":0,"median":0},"non_applicable":{"pass":1094.5,"median":1563}},"otherWeight":1,"combinedLimits":[],"maxPossibleScore":2400}},
            {"name": "芸術専門学類", "rule_data": {"groups":[{"cap":4,"name":"重点科目","weight":1,"subjects":["美術史学概論","芸術支援学概論","洋画概論","素描基礎演習1","油彩画基礎演習1","油彩画基礎演習2","版画概論","版画基礎演習","日本画概論","日本画基礎演習1","日本画基礎演習2","彫塑概論","彫塑基礎演習1","彫塑基礎演習2","彫塑基礎演習3","書概論","書基礎演習I-1","工芸概論","工芸基礎演習(ガラス)","工芸基礎演習(陶磁)","総合造形概論","立体加工基礎演習","構成概論","構成基礎演習","ビジュアルデザイン概論","グラフィックツール基礎演習","デジタル写真基礎演習","情報・プロダクトデザイン概論","レンダリング基礎演習","環境デザイン概論","プレゼンテーション基礎演習","建築デザイン概論","美術史概説A-1","美術史概説A-2","美術史概説B-1","美術史概説B-2","デザイン史概説A","デザイン史概説B"]}],"otherCap":0,"totalCap":24,"thresholds":{"applicable":{"pass":0,"median":0},"non_applicable":{"pass":515.5,"median":521.1}},"otherWeight":0.1,"combinedLimits":[],"maxPossibleScore":600}},
            {"name": "生物資源学類", "rule_data": {"groups":[{"cap":2,"name":"グループA","weight":2,"subjects":["生物資源学にみる食品科学・技術の最前線","生物資源の開発・生産と持続利用","生物資源と環境","生物資源としての遺伝子とゲノム"]},{"cap":6,"name":"グループB","weight":1,"subjects":["史学入門","考古学・民俗学入門","社会学の最前線","法学の最前線","政治学の最前線","経済学の最前線","生物学序説","系統分類・進化学概論","分子細胞生物学概論","遺伝学概論","生態学概論","動物生理学概論","植物生理学概論","地球環境学1","地球環境学2","地球進化学1","地球進化学2","数学リテラシー1","数学リテラシー2","微分積分A","微積分1","微積分2","微積分3","線形代数A","線形代数1","線形代数2","線形代数3","力学1","力学2","力学3","電磁気学1","電磁気学2","電磁気学3","化学1","化学2","化学3","経済学の数理","経済学の実証","会計と経営","社会と最適化","都市計画入門","都市数理","医科生化学","医科分子生物学"]}],"otherCap":0,"totalCap":24,"thresholds":{"applicable":{"pass":829.4,"median":861.05},"non_applicable":{"pass":784.7,"median":834.05}},"otherWeight":1,"combinedLimits":[],"maxPossibleScore":980}},
            {"name": "社会学類", "rule_data": {"groups":[],"otherCap":0,"totalCap":24,"thresholds":{"applicable":{"pass":2105.5,"median":2144.75},"non_applicable":{"pass":2078,"median":2087}},"otherWeight":1,"combinedLimits":[],"maxPossibleScore":2400}},
            {"name": "地球学類(理系Ⅱ)", "rule_data": {"groups":[{"cap":12,"name":"重点科目","weight":1,"subjects":["地球環境学1","地球環境学2","地球進化学2","地球進化学1","フィールド文化領域比較文化研究","生物学序説","系統分類・進化学概論","分子細胞生物学概論","遺伝学概論","生態学概論","動物生理学概論","植物生理学概論","生物資源学にみる食品科学・技術の最前線","生物資源の開発・生産と持続利用","生物資源と環境","生物資源としての遺伝子とゲノム","数学リテラシー1","数学リテラシー2","微分積分A","微積分1","微積分2","微積分3","線形代数A","線形代数1","線形代数2","線形代数3","力学1","力学2","力学3","電磁気1","電磁気2","電磁気3","化学1","化学2","化学3"]}],"otherCap":0,"totalCap":24,"thresholds":{"applicable":{"pass":922.8,"median":994.75},"non_applicable":{"pass":1094,"median":1109.12}},"otherWeight":1,"combinedLimits":[],"maxPossibleScore":1300}},
            {"name": "人文学類", "rule_data": {"groups":[],"otherCap":0,"totalCap":24,"thresholds":{"applicable":{"pass":1861,"median":1969.5},"non_applicable":{"pass":1723,"median":1844}},"otherWeight":1,"combinedLimits":[],"maxPossibleScore":2400}},
            {"name": "情報メディア創成学類", "rule_data": {"groups":[],"otherCap":0,"totalCap":24,"thresholds":{"applicable":{"pass":0,"median":0},"non_applicable":{"pass":0,"median":0}},"otherWeight":1,"combinedLimits":[],"maxPossibleScore":0}},
            {"name": "知識情報・図書館学類（理系Ⅲ）", "rule_data": {"groups":[],"otherCap":0,"totalCap":24,"thresholds":{"applicable":{"pass":0,"median":0},"non_applicable":{"pass":0,"median":0}},"otherWeight":1,"combinedLimits":[],"maxPossibleScore":0}},
            {"name": "知識情報・図書館学類（文系）", "rule_data": {"groups":[],"otherCap":0,"totalCap":24,"thresholds":{"applicable":{"pass":80,"median":90},"non_applicable":{"pass":70,"median":80}},"otherWeight":1,"combinedLimits":[],"maxPossibleScore":0}},
            {"name": "比較文化学類", "rule_data": {"groups":[],"otherCap":0,"totalCap":24,"thresholds":{"applicable":{"pass":2005,"median":2093},"non_applicable":{"pass":1958,"median":1984}},"otherWeight":1,"combinedLimits":[],"maxPossibleScore":2400}},
            {"name": "心理学類", "rule_data": {"groups":[],"otherCap":0,"totalCap":28,"thresholds":{"applicable":{"pass":0,"median":0},"non_applicable":{"pass":2402,"median":2433}},"otherWeight":1,"combinedLimits":[],"maxPossibleScore":2800}}
        ];


        let latestResultsForSubmission = [];
        const searchInput = document.getElementById('search-input');
        const searchResultsContainer = document.getElementById('search-results');
        const subjectsTableBody = document.querySelector('#subjects-table tbody');
        const addRowBtn = document.getElementById('add-row-btn');
        const saveBtn = document.getElementById('save-btn');
        const loadingStatus = document.getElementById('loading-status');
        const majorPriorityBody = document.getElementById('major-priority-body');
        const resultsPanel = document.getElementById('results-panel');
        const resultsTableBody = document.getElementById('results-table-body');
        const toggleMajorsBtn = document.getElementById('toggle-majors-btn');
        const majorPriorityContent = document.getElementById('major-priority-content');
        const submitResultsBtn = document.getElementById('submit-results-btn');
        const categorySelect = document.getElementById('category-select');
        
        function populateMajorPriorityTable() {
            majorRulesFromSQL.forEach(rule => {
                const row = document.createElement('tr');
                row.innerHTML = `<td>${rule.name}</td><td><input type="number" class="priority-input" data-major-name="${rule.name}" min="1" max="5" placeholder="1-5"></td>`;
                majorPriorityBody.appendChild(row);
            });
        }
        
        function loadCategorySelection() {
            const savedCategory = localStorage.getItem('userCategory') || 'unselected';
            categorySelect.value = savedCategory;
        }

        function loadPrioritiesFromLocalStorage() {
            try {
                const storedPriorities = localStorage.getItem('userMajorPriorities');
                if (storedPriorities) {
                    const priorities = JSON.parse(storedPriorities);
                    Object.entries(priorities).forEach(([majorName, priority]) => {
                        const input = majorPriorityBody.querySelector(`input[data-major-name="${majorName}"]`);
                        if (input) input.value = priority;
                    });
                }
            } catch (e) { console.error("Failed to load major priorities:", e); }
        }

        function loadPanelStates() {
            const majorsPanelState = localStorage.getItem('majorsPanelState');
            if (majorsPanelState === 'visible') {
                majorPriorityContent.style.display = 'block';
                toggleMajorsBtn.textContent = '非表示';
            } else {
                majorPriorityContent.style.display = 'none';
                toggleMajorsBtn.textContent = '表示';
            }
        }
        
        async function initializeApp() {
            populateMajorPriorityTable();
            loadCategorySelection();
            loadPanelStates();
            loadingStatus.textContent = '科目データを読み込み中...';
            searchInput.disabled = true;
            try {
                const response = await fetch('kdb_2025.csv');
                const csvText = await response.text();
                Papa.parse(csvText, {
                    header: true, skipEmptyLines: true,
                    complete: (results) => {
                        const uniqueSubjects = new Map();
                        results.data.forEach(row => {
                            const name = row['科目名'] ? row['科目名'].trim() : '';
                            const credits = parseFloat(row['単位数']);
                            if(name && !isNaN(credits)) {
                                const key = `${name}|${credits}`;
                                if (!uniqueSubjects.has(key)) { uniqueSubjects.set(key, { name, credits }); }
                            }
                        });
                        masterSubjects = Array.from(uniqueSubjects.values());
                    }
                });
                loadingStatus.textContent = '✅ 読み込み完了';
                searchInput.disabled = false;
                searchInput.placeholder = '科目ライブラリから検索...';
                setTimeout(() => { loadingStatus.textContent = ''; }, 3000);
            } catch (error) {
                loadingStatus.textContent = `❌ 科目データ(kdb_2025.csv)の読み込みに失敗`;
            }
            loadSubjectsFromLocalStorage();
            loadPrioritiesFromLocalStorage();
        }

        function createSubjectRow(subject = {}) {
            const row = document.createElement('tr');
            row.innerHTML = `<td class="col-name"><input type="text" class="subject-name" value="${subject.name || ''}" placeholder="例：力学1"></td><td class="col-credits"><input type="number" class="subject-credits" step="0.1" value="${subject.credits || ''}" placeholder="2.0"></td><td class="col-grade"><input type="number" class="subject-grade" min="0" max="100" value="${subject.grade || ''}" placeholder="95"></td><td class="col-actions"><button class="btn-remove">削除</button></td>`;
            subjectsTableBody.appendChild(row);
        }

        function populateTable(subjects) {
            subjectsTableBody.innerHTML = '';
            if (subjects && subjects.length > 0) subjects.forEach(createSubjectRow);
            else { createSubjectRow(); createSubjectRow(); createSubjectRow(); }
        }

        function loadSubjectsFromLocalStorage() {
            try {
                const storedSubjects = localStorage.getItem('userSubjects');
                populateTable(storedSubjects ? JSON.parse(storedSubjects) : []);
            } catch (e) { console.error("Failed to load subjects:", e); populateTable([]); }
        }

        document.addEventListener('DOMContentLoaded', initializeApp);
        addRowBtn.addEventListener('click', () => createSubjectRow());
        
        categorySelect.addEventListener('change', () => {
            localStorage.setItem('userCategory', categorySelect.value);
        });

        subjectsTableBody.addEventListener('click', (e) => {
            if (e.target.classList.contains('btn-remove') && subjectsTableBody.querySelectorAll('tr').length > 1) {
                e.target.closest('tr').remove();
            }
        });

        toggleMajorsBtn.addEventListener('click', () => {
            const isVisible = majorPriorityContent.style.display !== 'none';
            if (isVisible) {
                majorPriorityContent.style.display = 'none';
                toggleMajorsBtn.textContent = '表示';
                localStorage.setItem('majorsPanelState', 'hidden');
            } else {
                majorPriorityContent.style.display = 'block';
                toggleMajorsBtn.textContent = '非表示';
                localStorage.setItem('majorsPanelState', 'visible');
            }
        });

        searchInput.addEventListener('input', () => {
            const query = searchInput.value.toLowerCase();
            searchResultsContainer.innerHTML = '';
            if (!query) return;
            const currentSubjects = Array.from(subjectsTableBody.querySelectorAll('.subject-name')).map(input => input.value);
            const filtered = masterSubjects.filter(s => s.name.toLowerCase().includes(query) && !currentSubjects.includes(s.name));
            const displayLimit = 50;
            const itemsToDisplay = filtered.slice(0, displayLimit);
            itemsToDisplay.forEach(subject => {
                const item = document.createElement('div');
                item.className = 'result-item';
                item.innerHTML = `<span>${subject.name} (${subject.credits}単位)</span><button type="button" class="btn-add" data-name="${subject.name}" data-credits="${subject.credits}">追加</button>`;
                searchResultsContainer.appendChild(item);
            });
            if (filtered.length > displayLimit) {
                const moreResults = document.createElement('div');
                moreResults.className = 'result-item';
                moreResults.style.cssText = 'justify-content: center; color: #666;';
                moreResults.textContent = `${displayLimit}件以上ヒット。さらに絞り込んでください。`;
                searchResultsContainer.appendChild(moreResults);
            }
        });

        searchResultsContainer.addEventListener('click', (event) => {
            if (event.target.classList.contains('btn-add')) {
                const { name, credits } = event.target.dataset;
                if (Array.from(subjectsTableBody.querySelectorAll('.subject-name')).map(input => input.value).includes(name)) {
                    alert('この科目は既に追加されています。'); return;
                }
                let emptyRow = Array.from(subjectsTableBody.querySelectorAll('tr')).find(row => !row.querySelector('.subject-name').value);
                if (emptyRow) {
                    emptyRow.querySelector('.subject-name').value = name;
                    emptyRow.querySelector('.subject-credits').value = parseFloat(credits);
                } else {
                    createSubjectRow({ name, credits: parseFloat(credits) });
                }
                searchInput.value = '';
                searchResultsContainer.innerHTML = '';
            }
        });

        saveBtn.addEventListener('click', () => {
            saveBtn.disabled = true;
            saveBtn.textContent = '保存・計算中...';
            const subjectsRaw = Array.from(subjectsTableBody.querySelectorAll('tr')).map(row => ({ name: row.querySelector('.subject-name').value.trim(), credits: row.querySelector('.subject-credits').value, grade: row.querySelector('.subject-grade').value })).filter(s => s.name && s.credits && s.grade);
            const subjectsForCalc = subjectsRaw.map(s => ({ name: s.name, credits: parseFloat(s.credits), grade: parseFloat(s.grade) })).filter(s => s.name && !isNaN(s.credits) && !isNaN(s.grade));
            const majorPriorities = {};
            majorPriorityBody.querySelectorAll('.priority-input').forEach(input => {
                const priority = parseInt(input.value, 10);
                if (priority >= 1 && priority <= 5) majorPriorities[input.dataset.majorName] = priority;
            });
            const selectedMajors = Object.keys(majorPriorities);
            if (selectedMajors.length === 0) {
                alert('計算対象の学類に1つ以上、有効な志望度(1-5)を入力してください。');
                saveBtn.disabled = false;
                saveBtn.textContent = '現在のリストを保存・計算実行';
                resultsPanel.style.display = 'none';
                return;
            }
            try {
                localStorage.setItem('userSubjects', JSON.stringify(subjectsRaw));
                localStorage.setItem('userMajorPriorities', JSON.stringify(majorPriorities));
                
                const allRules = majorRulesFromSQL.map(r => ({ ...r.rule_data, name: r.name }));
                const filteredRules = allRules.filter(rule => selectedMajors.includes(rule.name));
                
                const calculationResults = {};
                filteredRules.forEach(rule => {
                    const result = (rule.type === 'tiered')
                        ? calculateTieredMajor(subjectsForCalc, rule)
                        : calculateStandardMajor(subjectsForCalc, rule);
                    calculationResults[rule.name] = result;
                });

                localStorage.setItem('calculatedScores', JSON.stringify(calculationResults));
                resultsTableBody.innerHTML = '';

                const combinedResults = Object.entries(calculationResults).map(([name, result]) => ({
                    name: name,
                    score: result.score,
                    priority: majorPriorities[name],
                    maxScore: result.maxScore
                }));
                
                combinedResults.sort((a, b) => {
                    if (a.priority !== b.priority) return a.priority - b.priority;
                    return b.score - a.score;
                });

                latestResultsForSubmission = combinedResults.map(r => {
                    const percentage = r.maxScore > 0 ? (r.score / r.maxScore) * 100 : 0;
                    return { ...r, percentage };
                });

                latestResultsForSubmission.forEach(result => {
                    const row = document.createElement('tr');
                    const percentageDisplay = result.maxScore > 0 ? `${result.percentage.toFixed(2)}%` : 'N/A';
                    row.innerHTML = `
                        <td>${result.name}</td>
                        <td>${result.priority}</td>
                        <td>${result.score.toFixed(2)}</td>
                        <td>${percentageDisplay}</td>
                    `;
                    resultsTableBody.appendChild(row);
                });
                
                resultsPanel.style.display = 'block';
            } catch(error) {
                alert('保存または計算に失敗しました: ' + error.message);
                console.error(error);
            } finally {
                saveBtn.disabled = false;
                saveBtn.textContent = '現在のリストを保存・計算実行';
            }
        });

        submitResultsBtn.addEventListener('click', async () => {
            const selectedCategory = categorySelect.value;
            if (selectedCategory === 'unselected') {
                alert('区分枠を選択してから送信してください。');
                return;
            }
            if (latestResultsForSubmission.length === 0) {
                alert('送信する計算結果がありません。先に計算を実行してください。');
                return;
            }

            // 確認メッセージを作成
            let confirmationMessage = `区分: ${categorySelect.options[categorySelect.selectedIndex].text}\n\n`;
            confirmationMessage += "送信する学類:\n";
            latestResultsForSubmission.forEach(r => {
                // --- START: MODIFIED LINE ---
                confirmationMessage += `- [${r.priority}位] ${r.name} (スコア: ${r.score.toFixed(2)})\n`;
                // --- END: MODIFIED LINE ---
            });
            confirmationMessage += "\n上記の内容で送信しますか？";

            // 確認ダイアログを表示し、ユーザーが「キャンセル」を押したら処理を中断
            if (!window.confirm(confirmationMessage)) {
                return; 
            }

            submitResultsBtn.disabled = true;
            submitResultsBtn.textContent = '送信中...';
            
            const WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbxI-EknOWN6KtlbfByK2t-5W2zQHW-2bQB5VBhNXFbHkra2CWAdaSUdRqs7R9RQg9b2yw/exec'; 

            try {
                const dataToSend = {
                    category: selectedCategory,
                    results: latestResultsForSubmission.map(r => ({ 
                        major: r.name, 
                        priority: r.priority, 
                        score: r.score, 
                        percentage: r.percentage 
                    }))
                };

                const formData = new FormData();
                formData.append('data', JSON.stringify(dataToSend));

                const response = await fetch(WEB_APP_URL, {
                    method: 'POST',
                    body: formData,
                });
                
                const result = await response.json();

                if (result.status === 'success') {
                    alert('送信が完了しました！スプレッドシートを確認してください。');
                } else {
                    throw new Error(result.message || 'スクリプト側でエラーが発生しました。');
                }

            } catch (error) {
                alert('送信に失敗しました: ' + error.message);
                console.error("Submission error:", error);
            } finally {
                submitResultsBtn.disabled = false;
                submitResultsBtn.textContent = '計算結果を送信';
            }
        });
    </script>
</body>
</html>
